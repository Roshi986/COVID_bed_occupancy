---
title: "Patient pathways paper - exploration"
author: "Quentin J. Leclerc, Gwenan M. Knight"
date: "`r format(Sys.time(), '%A %d %B %Y')`"
output:
  bookdown::pdf_document2
---


# Setup 

We load packages, pathways data, and read in the movement data from Excel.

```{r setup, include = F}
knitr::opts_chunk$set(echo = FALSE, message = F, warning = F)

library(openxlsx)
library(dplyr)
library(linelist)
library(knitr)
library(reshape2)
library(rlist)
library(here)

source(here::here("code", "core_model_functions.R"))
source(here::here("code", "paths_table_to_blocks.R"))

set.seed(3210)

```

```{r load_hospital_data}

#latest version of hosp data can be generated by sourcing the corresponding code:
#(generates a ton of objects, recommend clearing global envir after!)
#source(here::here("code", "import_hosp_data.R"))

hospital_data = read.csv(here::here("data", "uk_hospital_data.csv")) %>%
  mutate(date = as.Date(date))

regions_hospital_data = hospital_data %>%
  filter(!(geography %in% c("England", "Scotland", "Wales", "Northern Ireland")))

cov_curve = hospital_data %>%
  filter(geography == "England") %>%
  filter(value_type == "hospital_inc")


```


```{r load_uclh_data}

uclh_data = read.csv(here::here("data", "uclh_occupancy.csv")) %>%
  mutate(date = as.Date(date))

#need to extend cov_curve to fill in gaps and match max data date!
#in a future update, better to implement date column recognition in the model...
cov_curve_uclh = uclh_data %>%
  filter(value_type == "admission") %>%
  complete(date = seq.Date(min(date), max(uclh_data$date), by="day"), value_type) %>%
  mutate(value = replace_na(value, 0))


```

# Main results

## UCLH LoS, UCLH admissions

```{r all_simulations_uclh}

message("Simulating using average LoS...")
res_average_LoS_uclh = multi_pathways_model(100, 
                                            cov_curve_uclh$value, 
                                            total_LoS_all_uclh, 
                                            length(cov_curve_uclh$date),
                                            record_peak = T,
                                            verbose = T)

res_average_LoS_uclh_peak = res_average_LoS_uclh$summary_peak

res_average_LoS_uclh = res_average_LoS_uclh$summary_results
res_average_LoS_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_average_LoS_uclh_peak, here::here("outputs", "results", "res_average_LoS_uclh_peak.rds"))
saveRDS(res_average_LoS_uclh, here::here("outputs", "results", "res_average_LoS_uclh.rds"))


message("Simulating using full pathways...")
res_full_pathways_uclh = multi_pathways_model(100, 
                                              cov_curve_uclh$value, 
                                              pathways_all_uclh, 
                                              length(cov_curve_uclh$date),
                                              record_peak = T,
                                              verbose = T)

res_full_pathways_uclh_peak = res_full_pathways_uclh$summary_peak

res_full_pathways_uclh = res_full_pathways_uclh$summary_results
res_full_pathways_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_full_pathways_uclh_peak, here::here("outputs", "results", "res_full_pathways_uclh_peak.rds"))
saveRDS(res_full_pathways_uclh, here::here("outputs", "results", "res_full_pathways_uclh.rds"))

```

## CO-CIN LoS, England admissions

```{r all_simulations_eng}

message("Simulating using average LoS...")
res_average_LoS = multi_pathways_model(100, 
                                       cov_curve$value, 
                                       total_LoS_all, 
                                       length(cov_curve$date),
                                       record_peak = T,
                                       verbose = T)

res_average_LoS_peak = res_average_LoS$summary_peak

res_average_LoS = res_average_LoS$summary_results
res_average_LoS$date = as.Date(cov_curve$date)

saveRDS(res_average_LoS_peak, here::here("outputs", "results", "res_average_LoS_eng_peak.rds"))
saveRDS(res_average_LoS, here::here("outputs", "results", "res_average_LoS_eng.rds"))


message("Simulating using full pathways...")
res_full_pathways = multi_pathways_model(100, 
                                         cov_curve$value, 
                                         pathways_all, 
                                         length(cov_curve$date),
                                         record_peak = T,
                                         verbose = T,
                                         LoS_distribution = "custom")

res_full_pathways_peak = res_full_pathways$summary_peak

res_full_pathways = res_full_pathways$summary_results
res_full_pathways$date = as.Date(cov_curve$date)

saveRDS(res_full_pathways_peak, here::here("outputs", "results", "res_full_pathways_eng_peak.rds"))
saveRDS(res_full_pathways, here::here("outputs", "results", "res_full_pathways_eng.rds"))


```

## Run model by region

```{r simulate_region_average}

all_regions_results = data.frame()
all_regions_true_prev = data.frame()

for (i in unique(regions_hospital_data$geography)) {
  
  message("Currently on region ", i)
  
  data_reg = regions_hospital_data %>%
    filter(geography == i)
  
  cov_curve_reg = data_reg %>%
    filter(value_type == "hospital_inc") %>%
    select(value) %>%
    pull
  
  #giving it a spin with total LoS assumptions
  res_reg = multi_pathways_model(100, cov_curve_reg, total_LoS_all, length(cov_curve_reg))
  res_reg$region = i
  
  data_reg = data.frame(
    time = res_reg$time,
    date = unique(data_reg$date),
    Ward = data_reg %>% filter(value_type == "hospital_prev") %>% select(value) %>% pull,
    CC = data_reg %>% filter(value_type == "icu_prev") %>% select(value) %>% pull,
    region = i
  )
  
  
  all_regions_results = rbind(all_regions_results, res_reg)
  all_regions_true_prev = rbind(all_regions_true_prev, data_reg)
  
}

all_regions_results$date = rep(unique(data_reg$date), length(unique(all_regions_results$region)))

saveRDS(all_regions_results, here::here("outputs", "results", "res_regions_eng.rds"))
saveRDS(all_regions_true_prev, here::here("outputs", "results", "data_regions_eng.rds"))


```


# Supplementary

## UCLH LoS, UCLH admissions, lognormal distribution

```{r all_simulations_uclh_lognorm}

message("Simulating using average LoS...")
res_average_LoS_uclh = multi_pathways_model(100, 
                                            cov_curve_uclh$value, 
                                            total_LoS_all_uclh, 
                                            length(cov_curve_uclh$date),
                                            LoS_distribution = "lognormal",
                                            verbose = T)
res_average_LoS_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_average_LoS_uclh, here::here("outputs", "results", "res_average_LoS_uclh_lognorm.rds"))

message("Simulating using full pathways...")
res_full_pathways_uclh = multi_pathways_model(100, 
                                              cov_curve_uclh$value, 
                                              pathways_all_uclh, 
                                              length(cov_curve_uclh$date),
                                              LoS_distribution = "lognormal",
                                              verbose = T)
res_full_pathways_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_full_pathways_uclh, here::here("outputs", "results", "res_full_pathways_uclh_lognorm.rds"))

```

## UCLH LoS, UCLH admissions, Lognormal distribution, rounding

```{r all_simulations_uclh_lognorm_round}

message("Simulating using average LoS...")
res_average_LoS_uclh = multi_pathways_model(100, 
                                            cov_curve_uclh$value, 
                                            total_LoS_all_uclh, 
                                            length(cov_curve_uclh$date),
                                            LoS_distribution = "lognormal",
                                            LoS_rounding = "round",
                                            verbose = T)
res_average_LoS_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_average_LoS_uclh, here::here("outputs", "results", "res_average_LoS_uclh_lognorm_round.rds"))

message("Simulating using full pathways...")
res_full_pathways_uclh = multi_pathways_model(100, 
                                              cov_curve_uclh$value, 
                                              pathways_all_uclh, 
                                              length(cov_curve_uclh$date),
                                              LoS_distribution = "lognormal",
                                              LoS_rounding = "round",
                                              verbose = T)
res_full_pathways_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_full_pathways_uclh, here::here("outputs", "results", "res_full_pathways_uclh_lognorm_round.rds"))

```




## CO-CIN LoS, UCLH admissions

```{r all_simulations_uclh_cocin}

message("Simulating using average LoS...")
res_average_LoS_uclh = multi_pathways_model(100, 
                                            cov_curve_uclh$value, 
                                            total_LoS_all, 
                                            length(cov_curve_uclh$date),
                                            verbose = T)
res_average_LoS_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_average_LoS_uclh, here::here("outputs", "results", "res_average_LoS_uclh_cocin.rds"))

message("Simulating using full pathways...")
res_full_pathways_uclh = multi_pathways_model(100, 
                                              cov_curve_uclh$value, 
                                              pathways_all, 
                                              length(cov_curve_uclh$date),
                                              verbose = T,
                                              LoS_distribution = "custom")
res_full_pathways_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_full_pathways_uclh, here::here("outputs", "results", "res_full_pathways_uclh_cocin.rds"))

```

## UCLH LoS, England admissions

```{r all_simulations_eng_uclh}

message("Simulating using average LoS...")
res_average_LoS = multi_pathways_model(100, 
                                       cov_curve$value, 
                                       total_LoS_all_uclh, 
                                       length(cov_curve$date),
                                       verbose = T)
res_average_LoS$date = as.Date(cov_curve$date)

saveRDS(res_average_LoS, here::here("outputs", "results", "res_average_LoS_eng_uclh.rds"))

message("Simulating using full pathways...")
res_full_pathways = multi_pathways_model(100, 
                                         cov_curve$value, 
                                         pathways_all_uclh, 
                                         length(cov_curve$date),
                                         verbose = T)
res_full_pathways$date = as.Date(cov_curve$date)

saveRDS(res_full_pathways, here::here("outputs", "results", "res_full_pathways_eng_uclh.rds"))


```

## UCLH LoS, UCLH admissions, round LoS

```{r all_simulations_uclh_round}

message("Simulating using average LoS...")
res_average_LoS_uclh = multi_pathways_model(100, 
                                            cov_curve_uclh$value, 
                                            total_LoS_all_uclh, 
                                            length(cov_curve_uclh$date),
                                            LoS_rounding = "round",
                                            verbose = T)
res_average_LoS_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_average_LoS_uclh, here::here("outputs", "results", "res_average_LoS_uclh_round.rds"))

message("Simulating using full pathways...")
res_full_pathways_uclh = multi_pathways_model(100, 
                                              cov_curve_uclh$value, 
                                              pathways_all_uclh, 
                                              length(cov_curve_uclh$date),
                                              LoS_rounding = "round",
                                              verbose = T)
res_full_pathways_uclh$date = as.Date(cov_curve_uclh$date)

saveRDS(res_full_pathways_uclh, here::here("outputs", "results", "res_full_pathways_uclh_round.rds"))

```

## CO-CIN LoS, England admissions, round LoS

```{r all_simulations_eng_round}
# 
# message("Simulating using average LoS...")
# res_average_LoS = multi_pathways_model(100, 
#                                        cov_curve$value, 
#                                        total_LoS_all, 
#                                        length(cov_curve$date),
#                                        LoS_rounding = "round",
#                                        verbose = T)
# res_average_LoS$date = as.Date(cov_curve$date)
# 
# saveRDS(res_average_LoS, here::here("outputs", "results", "res_average_LoS_eng_round.rds"))

#skip pathways as using exact distribution
#message("Simulating using full pathways...")
# res_full_pathways = multi_pathways_model(10, 
#                                          cov_curve$value, 
#                                          pathways_all, 
#                                          length(cov_curve$date),
#                                          LoS_rounding = "round",
#                                          LoS_distribution = "custom",
#                                          verbose = T)
# res_full_pathways$date = as.Date(cov_curve$date)
# 
# saveRDS(res_full_pathways, here::here("outputs", "results", "res_full_pathways_eng_round.rds"))


```

## Run model by region, full pathways

```{r simulate_region_pathways}

all_regions_results = data.frame()
all_regions_true_prev = data.frame()

for (i in unique(regions_hospital_data$geography)) {
  
  message("Currently on region ", i)
  
  data_reg = regions_hospital_data %>%
    filter(geography == i)
  
  cov_curve_reg = data_reg %>%
    filter(value_type == "hospital_inc") %>%
    select(value) %>%
    pull
  
  #giving it a spin with total LoS assumptions
  res_reg = multi_pathways_model(100, cov_curve_reg, pathways_all, length(cov_curve_reg), LoS_distribution = "custom")
  res_reg$region = i
  
  data_reg = data.frame(
    time = res_reg$time,
    date = unique(data_reg$date),
    Ward = data_reg %>% filter(value_type == "hospital_prev") %>% select(value) %>% pull,
    CC = data_reg %>% filter(value_type == "icu_prev") %>% select(value) %>% pull,
    region = i
  )
  
  
  all_regions_results = rbind(all_regions_results, res_reg)
  all_regions_true_prev = rbind(all_regions_true_prev, data_reg)
  
}

all_regions_results$date = rep(unique(data_reg$date), length(unique(all_regions_results$region)))

saveRDS(all_regions_results, here::here("outputs", "results", "res_regions_eng_pathways.rds"))
saveRDS(all_regions_true_prev, here::here("outputs", "results", "data_regions_eng_pathways.rds"))


```


